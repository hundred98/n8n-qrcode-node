# n8n QR Code 节点包

## 功能概述

这是一个n8n社区节点包，提供完整的二维码生成和解析功能。包含四个主要节点：

- **QR Code Generator** - 二维码生成器
- **QR Code Reader** - 二维码读取器  
- **QR Code App Secrets Guide** - 二维码应用秘钥指南
- **QR Code Toolkit** - 二维码工具集

## 安装说明

### 方法一：使用N8N_CUSTOM_EXTENSIONS环境变量

1. 确保项目已安装依赖：
```bash
cd n8n-nodes-qrcode
npm install
```

2. 启动n8n时设置环境变量：
```bash
# Windows PowerShell
$env:N8N_CUSTOM_EXTENSIONS="E:\code\N8N\NextFlow
8n-nodes-qrcode"; n8n start

# Linux/Mac
N8N_CUSTOM_EXTENSIONS="/path/to/n8n-nodes-qrcode" n8n start
```

### 方法二：直接安装到n8n

```bash
# 在n8n项目目录中
cd /path/to/n8n
npm install /path/to/n8n-nodes-qrcode
```

## 节点功能详情

### 1. QR Code Generator (二维码生成器)

**功能**：将文本、URL或JSON数据转换为二维码

**输入参数**：
- **Text**：要编码的文本内容
- **Output Format**：输出格式（PNG Base64 或 SVG）
- **Size**：二维码尺寸（32-2048像素）

**输出**：包含二维码数据的JSON对象

### 2. QR Code Reader (二维码读取器)

**功能**：从图像中读取和解析二维码内容

**输入参数**：
- **Input Source**：输入源类型（文件路径、URL、Base64、文本）
- **Output Format**：输出格式（原始文本或JSON）
- **Advanced Options**：高级选项（最大宽度/高度等）

**输出**：解析后的二维码内容及相关元数据

### 3. QR Code App Secrets Guide (二维码应用秘钥指南)

**功能**：解析包含应用秘钥信息的二维码并处理应用秘钥数据

**输入参数**：
- **Input Source**：输入源类型
- **App Secret Handling**：应用秘钥处理选项（类型、格式等）
- **Advanced Options**：高级安全选项

**输出**：处理后的凭据数据和验证信息

### 4. QR Code Toolkit (二维码工具集)

**功能**：提供二维码相关操作的统一入口

**输入参数**：
- **Operation**：选择要执行的操作（生成、读取、凭据管理）

## 使用示例

### 生成二维码

1. 添加 "QR Code Generator" 节点
2. 在 "Text" 字段输入要编码的内容
3. 选择输出格式和尺寸
4. 执行工作流，获取生成的二维码数据

### 读取二维码

1. 添加 "QR Code Reader" 节点
2. 选择输入源类型
3. 提供二维码图像路径或数据
4. 执行工作流，获取解析结果

## 技术依赖

- `qrcode` - 二维码生成
- `jsqr` - 二维码解析  
- `sharp` - 图像处理
- `n8n-workflow` - n8n工作流集成

## 开发说明

项目使用标准的n8n节点开发规范：
- 所有节点都继承自n8n-workflow基类
- 使用构造函数初始化节点描述
- 支持错误处理和继续执行选项
- 符合n8n节点API版本1规范

## 功能概述

这个n8n社区节点将围绕二维码技术提供全面的功能支持，包括二维码生成和二维码解析两大核心功能，以及一些高级特性。

## 核心功能设计

### 1. 二维码生成功能

#### 基础生成功能
- **文本/URL转换**：将输入的文本或URL转换为二维码
- **JSON数据编码**：支持将JSON对象编码为二维码
- **多种输出格式**：
  - PNG图片
  - SVG矢量图
  - Base64编码字符串
  - 图片文件路径

#### 自定义参数
- **尺寸设置**：小(128px)、中(256px)、大(512px)或自定义像素值
- **颜色定制**：
  - 前景色设置
  - 背景色设置
  - 支持十六进制颜色代码和颜色名称
- **边距调整**：设置二维码四周空白区域大小
- **纠错级别**：
  - L (低) - 7%
  - M (中) - 15%  
  - Q (较高) - 25%
  - H (高) - 30%

#### 高级生成特性
- **Logo嵌入**：在二维码中心添加品牌Logo或图像
- **二维码样式**：
  - 圆形图案点
  - 方形图案点
  - 自定义角标样式
- **图片质量设置**：控制输出图片的压缩质量

### 2. 二维码解析功能

#### 基础解析功能
- **图片解析**：从上传的图片文件中读取二维码内容
- **URL解析**：通过URL获取远程图片并解析二维码
- **Base64解析**：解析Base64编码的图片中的二维码

#### 高级解析特性
- **批量处理**：一次处理包含多个二维码的图片
- **内容类型识别**：自动识别二维码中的数据类型（URL、文本、联系人信息等）
- **错误处理**：当图片中不包含二维码时提供友好的错误信息

### 3. 特殊功能

#### 数据处理功能
- **内容加密**：对二维码内容进行简单的加密处理
- **内容解密**：解析加密的二维码内容
- **数据验证**：检查解析后的数据是否符合预期格式

#### 实用工具功能
- **二维码有效性检查**：验证生成的二维码是否可被正确扫描
- **二维码对比**：比较两个二维码是否包含相同内容

**使用场景**：
- 安全传输API密钥、访问令牌等敏感信息
- 设备间安全共享认证凭据
- 简化凭据更新流程，通过扫码自动完成凭据替换

## 实现考虑点

为了确保二维码凭据管理功能安全可靠，我们需要详细考虑以下实现细节：

### 1. 特殊标志格式设计
- **唯一标识符**：使用特定的前缀如`n8n-app-secret:`作为标识
- **结构化JSON格式**：
  ```json
  {
    "type": "n8n-app-secret",
    "version": "1.0",
    "secretType": "apiKey",
    "secretName": "myApiSecret",
    "data": { "apiKey": "...", "otherField": "..." },
    "timestamp": 1623456789000,
    "nonce": "random-string"
  }
  ```
- **版本控制**：通过版本字段支持未来的格式升级
- **防重放机制**：添加时间戳和随机nonce值防止重放攻击

### 2. 加密传输机制
- **端到端加密**：在生成二维码前使用AES或RSA加密敏感内容
- **加密密钥交换**：对于高安全性需求，实现临时密钥交换机制
- **签名验证**：添加数字签名以验证数据完整性
- **过期时间**：为加密内容设置合理的过期时间

### 3. 权限控制体系
- **基于角色的访问控制**：只有具有应用秘钥管理权限的用户才能使用该功能
- **操作审计日志**：记录所有应用秘钥操作
- **IP限制**：可选的IP地址白名单限制
- **二次认证**：对于敏感应用秘钥操作要求额外验证

### 4. 验证与确认机制
- **预览确认**：在存储应用秘钥前显示非敏感信息供用户确认
- **强制确认步骤**：用户必须明确点击确认按钮才能完成应用秘钥存储
- **变更对比**：当更新现有应用秘钥时，显示新旧应用秘钥的差异对比
- **撤销选项**：提供短时间内撤销操作的可能性

### 5. 应用秘钥类型与兼容性
- **支持的应用秘钥类型**：
  - API密钥（单密钥）
  - OAuth令牌（访问令牌+刷新令牌）
  - 用户名/密码组合
  - 证书类凭据
  - 自定义多字段凭据
- **应用秘钥格式验证**：针对不同类型实施特定的格式验证规则
- **向后兼容性**：通过n8n data table API实现应用秘钥管理

### 6. 错误处理与恢复
- **详细错误信息**：提供清晰的错误原因和解决建议
- **失败重试机制**：允许在特定条件下安全重试
- **回滚功能**：当更新失败时能够回滚到先前的应用秘钥版本
- **异常监控**：对可疑或失败的操作进行专门监控

### 7. 安全最佳实践
- **内存安全**：敏感数据在处理后立即从内存中清除
- **最小权限原则**：节点仅请求必要的权限来执行操作
- **定期安全审计**：设计时考虑未来的安全审计需求
- **合规性考虑**：遵循相关数据保护法规要求

这些详细的实现考虑点将确保二维码应用秘钥管理功能既实用又安全，能够满足企业级应用的需求。

## 技术实现规划

### 推荐使用的库
- **node-qrcode**：用于生成高质量的二维码图像
- **jsQR**：用于解析二维码内容
- **sharp**：用于图像处理（如添加Logo、调整大小等）

### 节点设计

#### 节点类型
1. **QRCodeGenerator节点**：专注于二维码生成功能
2. **QRCodeReader节点**：专注于二维码解析功能
3. **应用秘钥管理功能**：集成到QRCode节点中，用于提供与n8n data table集成的指引

#### 输入/输出设计
- **输入**：支持文本输入、文件输入、URL输入
- **输出**：根据功能返回二维码图像、解析后的文本或结构化数据

### 应用秘钥管理功能设计

#### 节点功能描述
应用秘钥管理功能集成在QRCode节点中，提供与n8n data table API集成的指引，用于存储和管理应用秘钥信息。

**重要说明：** 
- 该功能通过n8n data table API来存储和管理应用秘钥
- 用户可以通过HTTP Request节点与data table API交互，实现秘钥的创建、删除和查询操作

#### 输入参数
1. **输入源**：
   - 图片文件路径
   - 图片URL
   - Base64编码的图片数据
   - 已解析的二维码文本内容

2. **安全配置**：
   - **特殊标志前缀**：建议使用标识前缀（例如：`n8n-app-secret:`）
   - **加密密钥**：用于解密加密的应用秘钥内容（可选）
   - **验证签名**：是否验证数字签名（布尔值）
   - **最大过期时间**：接受的二维码最大有效期（分钟）

3. **操作配置**：
   - **覆盖现有应用秘钥**：是否允许更新已存在的应用秘钥
   - **要求确认**：是否需要用户手动确认应用秘钥更新
   - **详细日志**：是否记录详细操作日志（不含敏感数据）

#### 输出格式
1. **成功输出**：
   ```json
   {
     "success": true,
     "action": "create" or "update",
     "secretName": "应用秘钥名称",
     "secretType": "应用秘钥类型",
     "timestamp": "操作时间戳",
     "message": "操作成功描述"
   }
   ```

2. **失败输出**：
   ```json
   {
     "success": false,
     "errorCode": "错误代码",
     "errorMessage": "详细错误信息",
     "timestamp": "错误发生时间戳"
   }
   ```

#### 操作流程
1. **输入处理**：接收图片或文本输入
2. **二维码解析**：如果输入是图片，先解析二维码内容
3. **格式验证**：检查内容是否包含有效应用秘钥标记
4. **结构解析**：解析JSON格式的应用秘钥数据
5. **安全验证**：
   - 验证时间戳和过期时间
   - 验证nonce值防止重放攻击
   - 验证数字签名（如启用）
6. **解密处理**：对加密内容进行解密（如需要）
7. **应用秘钥操作**：
   - 检查应用秘钥是否已存在
   - 如需确认，等待用户确认
   - 通过data table API创建新应用秘钥或更新现有应用秘钥
8. **结果返回**：返回操作结果和状态信息

#### 错误处理机制
- **格式错误**：返回详细的格式验证错误
- **过期错误**：检测到过期的二维码内容
- **签名错误**：数字签名验证失败
- **权限错误**：用户没有访问data table API的权限
- **冲突错误**：应用秘钥已存在且配置为不允许覆盖

#### 安全保障措施
- 内存中的敏感数据处理完毕后立即清除
- 所有操作符合最小权限原则
- 记录所有应用秘钥操作的完整审计日志
- 支持二次认证要求
- 应用秘钥内容在处理过程中加密存储

## 使用场景示例

1. **营销自动化**：批量生成包含不同追踪参数的URL二维码
2. **数据共享**：将复杂数据编码为二维码以便快速传输
3. **工作流集成**：在自动化工作流中生成或解析二维码
4. **身份验证**：生成包含临时令牌的安全二维码
5. **信息采集**：扫描并解析包含结构化数据的二维码
6. **应用秘钥管理**：通过二维码和n8n data table API管理API密钥、访问令牌等应用秘钥

## 后续扩展可能性

1. **动态二维码**：支持生成指向可更新内容的二维码
2. **二维码美化**：提供更多的设计选项和自定义样式
3. **数据分析**：添加扫描统计和分析功能（需外部服务）
4. **其他码制支持**：扩展支持条形码等其他码制

---

请告诉我您对这个功能方案的看法，我们可以进一步讨论和完善。